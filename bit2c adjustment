import pandas as pd
from functions import OpenFile
import xlwt
from xlwt import Workbook

path = OpenFile()
file = pd.read_excel(path)

condition_fees =file['accountAction'] == "FeeWithdrawal"
fees_file = file[condition_fees]
fees_amount = fees_file['feeAmount'].sum()

condition_buy = file['accountAction'] == "Buy"
condition_sell = file['accountAction'] == "Sell"
file = file[condition_buy | condition_sell]
if file.empty:
    print('No sales or purchases on this years file')
    exit()

file = file.rename(columns ={'created':'Date', 'accountAction':'Action','firstCoin':'Symbol','secondCoin':'Currency','firstAmount':'Volume','feeAmount':'Fee','fee':'FeeCurrency'})
file.drop(columns = ['id','secondAmount','ref'],axis = 1, inplace = True)
file.loc[file['Currency'] == 'NIS', 'Currency'] = 'ILS'

file['FeeCurrency'] = 'ILS'
file['Source'] = 'Bit2C'

where_to_save = path[:-4] + " Bitcoin_tax_ready.xlsx"
writer = pd.ExcelWriter(where_to_save, engine='xlsxwriter')
file.to_excel(writer, index=False, encoding='UTF-8')
writer.save()

if fees_amount > 0:
    wb = Workbook()
    sheet1 = wb.add_sheet('Sheet 1')
    sheet1.write(0, 0, fees_amount)
    fee_path = path[:-4] + " Unaccounted_for_fees.xls"
    wb.save(fee_path)

else:
    pass

print(file)

