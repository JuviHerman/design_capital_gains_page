import pandas as pd
from functions import OpenFile
from xlwt import Workbook

#choose file
path = OpenFile()
file = pd.read_excel(path)

#figure out how many fees are in file who weren't added to assets cost
condition_fees =file['accountAction'] == "FeeWithdrawal"
fees_file = file[condition_fees]
fees_amount = fees_file['feeAmount'].sum()
del condition_fees
del fees_file

#filter the file in order to retain the actual trades that had occured(buy and sell)
condition_buy = file['accountAction'] == "Buy"
condition_sell = file['accountAction'] == "Sell"
file = file[condition_buy | condition_sell]
if file.empty:
    print('No sales or purchases on this years file')
    exit()

#adjust column names to program accepted column names
file = file.rename(columns ={'created':'Date', 'accountAction':'Action','firstCoin':'Symbol','secondCoin':'Currency','firstAmount':'Volume','feeAmount':'Fee','fee':'FeeCurrency'})

#delete unnecessary columns
file.drop(columns = ['id','secondAmount','ref'],axis = 1, inplace = True)

#correct values in table
file.loc[file['Currency'] == 'NIS', 'Currency'] = 'ILS'

#add necessary columns and values
file['FeeCurrency'] = 'ILS'
file['Source'] = 'Bit2C'

#save to excel file
where_to_save = path[:-4] + " Bitcoin_tax_ready.xlsx"
writer = pd.ExcelWriter(where_to_save, engine='xlsxwriter')
file.to_excel(writer, index=False, encoding='UTF-8')
writer.save()

#if there are fees not added to asset cost, then write it down to a file for further use in tax report.
if fees_amount > 0:
    wb = Workbook()
    sheet1 = wb.add_sheet('Sheet 1')
    sheet1.write(0, 0, fees_amount)
    fee_path = path[:-4] + " Unaccounted_for_fees.xls"
    wb.save(fee_path)
else:
    pass

#results
print(file)

